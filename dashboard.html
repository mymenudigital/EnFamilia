<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestión de Precios</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Carga variables de entorno locales o inyectadas -->
    <script src="env.js"></script>
    <script>
        // Si env.js no existe (producción sin configuración manual), usa valores por defecto o espera inyección
        window.SUPABASE_URL = window.SUPABASE_URL || '__SUPABASE_URL__';
        window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '__SUPABASE_KEY__';

        try {
            const { createClient } = window.supabase;
            window.supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            console.log('Supabase initialized successfully');
        } catch (err) {
            console.error('Error initializing Supabase:', err);
        }
    </script>
    <style>
        :root {
            --gold: #D4AF37;
            --dark-gold: #B8860B;
            --light-gold: #FFD700;
            --pale-gold: #FFF8DC;
            --charcoal: #2C3E50;
            --cream: #FFFDF0;
            --danger: #e74c3c;
            --success: #2ecc71;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: var(--cream);
            margin: 0;
            padding: 20px;
            color: var(--charcoal);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
        }

        .section-title {
            color: var(--dark-gold);
            margin: 0;
        }

        .logout-btn {
            background-color: var(--charcoal);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .menu-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-item-card {
            background-color: var(--pale-gold);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .menu-item-card input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--gold);
            border-radius: 4px;
            font-family: inherit;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .btn {
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.3s;
            font-family: inherit;
            font-weight: bold;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .save-btn {
            background-color: var(--gold);
            color: white;
            flex-grow: 1;
            margin-right: 10px;
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
        }

        .add-item-form {
            background-color: rgba(212, 175, 55, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed var(--gold);
        }

        .add-item-form h3 {
            margin-top: 0;
            color: var(--dark-gold);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--gold);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--gold);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .error {
            background-color: #fadbd8;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>

<body>
    <!-- SECCIÓN DE LOGIN -->
    <div id="loginSection" class="login-container">
        <h2 class="section-title">Restaurante En Familia</h2>
        <p>Panel de Gestión</p>
        <form id="loginForm" class="login-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <button type="submit" class="login-btn">Entrar</button>
        </form>
        <div id="loginMessage" class="message"></div>
    </div>

    <!-- SECCIÓN DE DASHBOARD -->
    <div id="dashboardSection" class="dashboard-container" style="display: none;">
        <div class="header">
            <h1 class="section-title">Gestión del Menú</h1>
            <button onclick="handleLogout()" class="logout-btn">Cerrar Sesión</button>
        </div>
        <div id="menuSections"></div>
    </div>

    <script>
        // Estructura del menú para organizar los items
        const menuSections = [
            { index: 0, title: 'Entrantes Calientes' },
            { index: 1, title: 'Entrantes Fríos' },
            { index: 2, title: 'Ensaladas' },
            { index: 3, title: 'Tostas' },
            { index: 4, title: 'Salsas' },
            { index: 5, title: 'Pescados' },
            { index: 6, title: 'Carnes' },
            { index: 7, title: 'Carnes a la Parrilla' },
            { index: 8, title: 'Pastas' },
            { index: 9, title: 'Arroces' },
            { index: 10, title: 'Platos Especiales' },
            { index: 11, title: 'Refrescos' },
            { index: 12, title: 'Cócteles y Licores' }
        ];

        // --- GESTIÓN DE SESIÓN ---

        async function checkSession() {
            if (!window.supabaseClient) {
                console.error('Supabase client not initialized');
                return;
            }
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (session) {
                showDashboard();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            if (!window.supabaseClient) {
                showMessage('loginMessage', 'Error: Cliente Supabase no inicializado', 'error');
                return;
            }
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msgDiv = document.getElementById('loginMessage');

            msgDiv.style.display = 'none';

            try {
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;
                showDashboard();

            } catch (error) {
                showMessage('loginMessage', error.message, 'error');
            }
        }

        async function handleLogout() {
            await window.supabaseClient.auth.signOut();
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            loadMenuItems();
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
        }

        // --- GESTIÓN DE DATOS ---

        async function loadMenuItems() {
            try {
                const { data, error } = await supabaseClient
                    .from('menu_items')
                    .select('*')
                    .order('name'); // Ordenar alfabéticamente dentro de la sección

                if (error) throw error;
                renderMenu(data);
            } catch (error) {
                alert('Error cargando menú: ' + error.message);
            }
        }

        function renderMenu(items) {
            const container = document.getElementById('menuSections');
            container.innerHTML = '';

            menuSections.forEach(section => {
                const sectionItems = items.filter(item => item.section_index === section.index);

                const html = `
                    <div class="menu-section">
                        <h2 class="section-title" style="margin-top: 40px; border-bottom: 1px solid #eee;">${section.title}</h2>
                        
                        <!-- Lista de platos existentes -->
                        <div class="menu-items-grid">
                            ${sectionItems.map(item => `
                                <div class="menu-item-card" id="card-${item.id}">
                                    <div class="input-group">
                                        <label>Nombre del Plato</label>
                                        <input type="text" id="name-${item.id}" value="${item.name}">
                                    </div>
                                    <div class="input-group">
                                        <label>Precio (€)</label>
                                        <input type="number" step="0.01" id="price-${item.id}" value="${item.price}">
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn save-btn" onclick="updateItem(${item.id})">Guardar Cambios</button>
                                        <button class="btn delete-btn" onclick="deleteItem(${item.id})">Eliminar</button>
                                    </div>
                                    <div id="msg-${item.id}" class="message" style="margin-top:5px; font-size:0.9em;"></div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Formulario de añadir nuevo -->
                        <div class="add-item-form">
                            <h3>+ Añadir a ${section.title}</h3>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <div style="flex-grow: 1;">
                                    <input type="text" id="new-name-${section.index}" placeholder="Nombre del nuevo plato">
                                </div>
                                <div style="width: 100px;">
                                    <input type="number" step="0.01" id="new-price-${section.index}" placeholder="Precio">
                                </div>
                                <button class="btn save-btn" style="width: auto;" onclick="addItem(${section.index})">Añadir</button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function updateItem(id) {
            const name = document.getElementById(`name-${id}`).value;
            const price = document.getElementById(`price-${id}`).value;
            const btn = document.querySelector(`#card-${id} .save-btn`);

            btn.disabled = true;
            btn.textContent = 'Guardando...';

            try {
                const { error } = await supabaseClient
                    .from('menu_items')
                    .update({ name, price })
                    .eq('id', id);

                if (error) throw error;

                // Feedback visual
                btn.textContent = '¡Guardado!';
                btn.style.backgroundColor = 'var(--success)';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'Guardar Cambios';
                    btn.style.backgroundColor = 'var(--gold)';
                }, 2000);

            } catch (error) {
                alert('Error al actualizar: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Reintentar';
            }
        }

        async function deleteItem(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este plato?')) return;

            try {
                const { error } = await supabaseClient
                    .from('menu_items')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Eliminar del DOM
                document.getElementById(`card-${id}`).remove();

            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        }

        async function addItem(sectionIndex) {
            const nameInput = document.getElementById(`new-name-${sectionIndex}`);
            const priceInput = document.getElementById(`new-price-${sectionIndex}`);

            const name = nameInput.value;
            const price = priceInput.value;

            if (!name || !price) {
                alert('Por favor completa nombre y precio');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('menu_items')
                    .insert([{ name, price, section_index: sectionIndex }]);

                if (error) throw error;

                // Limpiar inputs y recargar
                nameInput.value = '';
                priceInput.value = '';
                await loadMenuItems(); // Recarga simple para mostrar el nuevo item

            } catch (error) {
                alert('Error al añadir: ' + error.message);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            checkSession();
        });

    </script>
</body>

</html>